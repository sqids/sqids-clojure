name: Clojure CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/cache@v3
        with:
          path: |
            /home/runner/.m2
            /home/linuxbrew/.linuxbrew
            /home/runner/.cache/pre-commit
          key: ${{ runner.os }}-sqids-clojure
      - name: Add Homebrew to path
        run: echo /home/linuxbrew/.linuxbrew/bin >> "$GITHUB_PATH"
      - name: Install Homebrew
        run: |
          if ! command -v brew >/dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
      - name: Install dependencies
        run: bin/install-deps
      - name: Run pre-commit hooks
        run: pre-commit run --all-files
      - name: Run clj tests
        run: bin/run-tests clj
      - name: Run cljs tests
        run: bin/run-tests cljs
